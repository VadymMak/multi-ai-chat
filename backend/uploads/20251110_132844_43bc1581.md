# AI Assistant Refactor Roadmap — Checklist
_Last updated: 2025‑08‑16_

> Mark items with `[x]` as you complete them. Return this file to me anytime and I’ll refresh the plan.

---

## Phase 1 — P0: Backend Summarization & Rotation
- [ ] **/api/chat/summarize**
  - [ ] Always persist divider message as `sender="final"`, `isSummary=true` (safe if no history).
  - [ ] On `rotate_session:true` or token overflow → return `new_chat_session_id`.
  - [ ] Add `no_messages` flag when nothing to summarize.
  - [ ] Guard writes with FK-safe flow (ensure parent role/project exist or degrade gracefully).
  - [ ] (Optional) `?debug=1` → include `input_tokens`, `output_tokens`.
- [ ] **/api/ask**
  - [ ] Preflight token count; if `HARD_TOKEN_LIMIT` exceeded → summarize + rotate.
  - [ ] Return `{ rotated, new_chat_session_id?, divider_message? }` when rotation happens.
- [ ] **Settings/Thresholds**
  - [ ] `SOFT_TOKEN_LIMIT=1500`, `HARD_TOKEN_LIMIT=3000` (per‑model override ready).
- [ ] **Memory utils**
  - [ ] Compact summaries (~600 tokens), prefer code/requirements signals.
- [ ] **Logging**
  - [ ] `[Summarization] compressed X→Y` + `[Token Preflight] total=X`

---

## Phase 2 — P0: Frontend Rendering & UX Speed
- [ ] **Unified renderer**
  - [ ] One `renderMessage(text, meta)` for streaming & final.
  - [ ] Tighter spacing: paragraphs `mb-1.5 last:mb-0 leading-[1.45]`; lists `space-y-0.5`.
  - [ ] Poems (plain) as `whitespace-pre-wrap` (no bullets).
- [ ] **Typing/indicator**
  - [ ] Indicator stays in-flow (no layout jump); hides when `isTyping=false`.
- [ ] **Message list**
  - [ ] (Now) memoize bubbles; (Soon) virtualize with `react-virtuoso` for 100+ msgs.
- [ ] **Session rotation UX**
  - [ ] “Start new chat” → calls `/api/chat/summarize`, inserts divider, adopts `new_chat_session_id`.
  - [ ] Input focus + pinned autoscroll during stream; smooth on finalize.
- [ ] **YouTube/Web cards**
  - [ ] Mount after text, only when stream done; safe links; no duplicate markdown YT blocks.

---

## Phase 3 — P1: Observability & Diagnostics
- [ ] `?debug=1` on `/api/ask` and `/api/chat/summarize`
  - [ ] Include `{ ttfb_ms, ttlb_ms, input_tokens, output_tokens, summarized, rotated }`.
- [ ] Logs
  - [ ] Per‑turn timings + rotate triggers.
- [ ] Dev panel (optional)
  - [ ] Small “⚡ perf” panel in UI showing last 3 turns.

---

## Phase 4 — P1: Output Modes & YouTube Polish
- [ ] Toggle in input bar: `output_mode` (Plain/Markdown/Code) + `presentation` (Default/Poem‑plain/Poem‑code).
- [ ] Plain‑mode policy decided (strict vs liberal inline backticks).
- [ ] YouTube cards: dedupe by lowercased title+URL, ellipsis long titles, tooltip on hover.

---

## Phase 5 — P2: Memory Evolution (Optional)
- [ ] Embeddings for compact summaries (future RAG).
- [ ] Canon extraction improvements (+ endpoints to retrieve/manage).
- [ ] Git project import → long‑term memory (file tree, deps).
- [ ] Per‑project thresholds in settings.

---

## Test Matrix (Swagger / curl)
- [ ] **A**: Plain ask (short) → 200 + `provider`, `answer`, `chat_session_id`.
- [ ] **B**: Placeholder/guardrails for repetitive input → 200 + markdown render meta.
- [ ] **C1**: Code sample (Python) → plain/markdown as requested.
- [ ] **C2**: Poem (plain) → no code fence; **C3**: Poem (code) → single block with filename.
- [ ] **D1**: YouTube intent via `youtube:` → text + `sources.youtube[]` (no fenced block).
- [ ] **D2**: GET `/api/youtube/search` → array `{title,videoId,url,description}`.
- [ ] **E1/E2**: Mixed technical markdown → consistent spacing classes.
- [ ] **G**: `provider:"all"` parity: openai/claude + `summary` + per‑provider render.
- [ ] **Summarize**: POST `/api/chat/summarize` with/without `rotate_session`, check `divider_message`, `new_chat_session_id`.

---

## Rollout & Safety
- [ ] Feature flag for rotation/summarization changes.
- [ ] DB safety: idempotent `store_chat_message`, tolerant to missing parent rows.
- [ ] Config surfaced via `/api/config` for FE (thresholds, flags).

---

## Definition of Done
- [ ] P0 phases deliver <1000 tokens context after summarization on long threads.
- [ ] UI shows no layout jumps; smooth scrolling on 100+ messages.
- [ ] Debug metrics available and trustworthy.
- [ ] Swagger tests A–G + Summarize green.

---

**Owner:** @you • **Next review:** in 1 week
